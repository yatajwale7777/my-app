<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Apps Script Dashboard Project</title>
<style>
  /* ---------- base ---------- */
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:linear-gradient(135deg,#f0f6ff 0%, #f7fbf9 100%);margin:0;padding:18px;color:#172b4d}
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  header h1{font-size:18px;margin:0;color:#08203a}
  .tabs{display:flex;gap:8px}
  .tab{padding:8px 12px;border-radius:8px;background:#e9eef6;cursor:pointer;color:#08306b;font-weight:700}
  .tab.active{background:#0b63ff;color:#fff;box-shadow:0 6px 20px rgba(11,99,255,0.12)}
  .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(20,30,60,0.06);margin-bottom:12px}
  label{display:block;font-weight:700;margin-top:8px;color:#234}
  input,select,button,textarea{padding:8px;border-radius:8px;border:1px solid #d6dbe6;width:100%;box-sizing:border-box;font-size:14px;background:#fff}
  select[multiple]{height:120px}
  .row{display:flex;gap:12px}
  .col{flex:1}
  button.primary{background:#0b63ff;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
  .muted{color:#4f5b66;font-size:13px;margin-top:6px}
  pre.debug{background:#071022;color:#dbe9ff;padding:10px;border-radius:6px;overflow:auto;max-height:220px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid #eef3fb;text-align:left;vertical-align:top;font-size:13px}
  th{background:#08306b;color:#fff;position:sticky;top:0;z-index:2}
  tr:hover{background:#f3f8ff;cursor:pointer}
  @media (max-width:760px){ .row{flex-direction:column} }

  /* ---------- compact filters ---------- */
  #filtersCard{display:block;margin-top:12px}
  .filters-top{display:flex;gap:8px;align-items:center}
  .filters-top .col{flex:1 1 240px;min-width:140px}
  .filters-bottom{display:flex;gap:8px;margin-top:8px;align-items:center}
  .filters-bottom .col{flex:1 1 200px;min-width:120px}
  #tableWrap{margin-top:12px;height:calc(100vh - 340px);overflow:auto;border-radius:10px;background:#fff;padding:8px;box-shadow: inset 0 0 0 1px rgba(0,0,0,0.02)}
  @media (max-width:820px){ .filters-top,.filters-bottom{flex-direction:column} #tableWrap{height:auto} }

  /* ---------- detail panel ---------- */
  .detail-panel{position:fixed;right:18px;top:84px;width:420px;max-width:92%;background:#fff;border-radius:10px;box-shadow:0 12px 40px rgba(8,48,96,0.18);padding:14px;z-index:9999;display:none}
  .detail-panel h3{margin:0 0 8px 0;font-size:16px;color:#08306b}
  .detail-panel .kv{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eef3fb;font-size:13px}
  .detail-close{position:absolute;right:8px;top:8px;cursor:pointer;color:#888;font-weight:700}
  @media (max-width:820px){ .detail-panel{left:8px;right:8px;top:80px;width:auto} }

  /* small helpers */
  .muted-2{color:#637381;font-size:13px;margin-top:8px}
/* MOBILE / SMALL SCREENS TWEAKS */
@media (max-width: 520px) {
  /* Make header / controls stack vertically */
  .row, .filters-top, .filters-bottom {
    flex-direction: column !important;
    gap: 8px !important;
  }

  /* Reduce input/button paddings so things don't overflow */
  input, select, button {
    padding: 8px 10px !important;
    font-size: 14px !important;
  }

  /* Login button: don't stretch too tall, keep reasonable width */
  #loginBtn {
    flex: 0 0 auto !important;
    padding: 8px 12px !important;
    font-size: 14px !important;
    min-width: 120px;
  }
}

  /* Make logout button similar size */
  #logoutBtn {
    padding: 8px 12px !important;
    font-size: 14px !important;
    min-width: 120px;
  }

  /* Ensure the input next to buttons stretches full width when stacked */
  #loginInput {
    width: 100% !important;
    box-sizing: border-box;
  }

  /* Filters: make selects full width and close gap */
  #filtersCard select, #filtersCard input {
    width: 100% !important;
    margin: 0 !important;
  }

  /* Table container: reduce vertical height on small screens */
  #tableWrap {
    height: auto !important;
    max-height: calc(100vh - 300px) !important;
  }

  /* Detail panel becomes bottom modal (full width) on small screens */
  .detail-panel {
    left: 8px !important;
    right: 8px !important;
    top: auto !important;
    bottom: 8px !important;
    width: auto !important;
    max-height: 60vh;
    overflow: auto;
  }

  /* Reduce card paddings for compactness */
  .card { padding: 10px !important; }
/* MOBILE / SMALL SCREEN DROPDOWNS COMPACT */
@media (max-width: 520px) {
  /* Compact filters */
  #filtersCard {
    padding: 6px !important;
  }

  #filtersCard label {
    margin-top: 4px !important;
    font-size: 13px !important;
  }

  #filtersCard select,
  #filtersCard input {
    width: 100% !important;
    margin: 2px 0 !important;
    padding: 6px 8px !important;
    font-size: 13px !important;
    border-radius: 4px !important;
  }

  /* Reduce spacing between dropdowns */
  #filtersCard div {
    margin-bottom: 4px !important;
  }

  /* Reduce gap between stacked filter blocks */
  .filters-top,
  .filters-bottom {
    gap: 4px !important;
  }
}

</style>

<!-- ===== set your Apps Script /exec URL here (REPLACE this URL if needed) ===== -->
<script>
  // Edit this line: paste your Netlify function /api URL here:
  window.API_URL = window.API_URL || "https://my-app-works.netlify.app/.netlify/functions/api";
</script>
</head>
<body>
<div class="wrap">
  <header>
    <h1>UserID Creator + Works Dashboard</h1>
    <div class="tabs">
      <div id="tabCreate" class="tab">Create</div>
      <div id="tabDashboard" class="tab active">Dashboard</div>
    </div>
  </header>

  <!-- CREATE -->
  <section id="createSection" class="card" style="display:none;">
    <h2 style="margin:0 0 8px 0">Create / Update UserID</h2>
    <div class="muted">Fill Name, Post, select Panchayats (multi) and Save.</div>

    <label for="name">Name</label>
    <input id="name" placeholder="e.g. Irfan Qureshi">

    <label for="post">Post</label>
    <select id="post"><option>Loading...</option></select>

    <label for="panchayats">Panchayats (Ctrl/Cmd to multi-select)</label>
    <select id="panchayats" multiple></select>

    <label for="dcode">DCode</label>
    <input id="dcode" value="77">

    <div style="margin-top:10px" class="row">
      <div class="col"><button id="btnPreview" class="primary" style="background:#06a6a6">Preview</button></div>
      <div class="col"><button id="btnSave" class="primary">Save & Open Dashboard</button></div>
    </div>

    <div id="previewArea" style="margin-top:10px">
      <div id="status" class="muted"></div>
      <div id="preview" class="muted-2"></div>
    </div>

    <hr style="margin:14px 0">

    <details>
      <summary style="cursor:pointer">Debug / Last backend responses</summary>
      <div style="margin-top:8px">
        <pre id="debugCreate" class="debug">no calls yet</pre>
      </div>
    </details>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboardSection" class="card" style="display:block">
    <h2 style="margin:0 0 8px 0">Works Dashboard</h2>
    <div id="lastUpdate" class="muted">Loading...</div>

    <label>Login (UserID or Name)</label>
    <div class="row" style="align-items:center">
      <input id="loginInput" placeholder="Enter UserID or Name">
      <button id="loginBtn" class="primary" style="flex:0 0 160px;margin-left:8px">Login</button>
      <button id="logoutBtn" style="background:#e07a5f;color:#fff;border:none;padding:10px 12px;border-radius:8px;display:none;margin-left:8px">Logout</button>
    </div>

    <div id="userInfo" class="muted" style="margin-top:8px"></div>

    <div id="filtersCard" style="margin-top:12px;display:none">
      <div class="filters-top">
        <div class="col">
          <label>Engineer</label>
          <select id="engineer"></select>
        </div>
        <div class="col">
          <label>Panchayat (yours only)</label>
          <select id="gp"></select>
        </div>
      </div>

      <div class="filters-bottom">
        <div class="col">
          <label>Year</label>
          <select id="year"></select>
        </div>
        <div class="col">
          <label>Work Type</label>
          <select id="work"></select>
        </div>
        <div class="col">
          <label>Status</label>
          <select id="status"></select>
        </div>
        <div class="col">
          <label>Category</label>
          <select id="category"></select>
        </div>
      </div>

      <label>Search</label>
      <input id="search" placeholder="keyword">

      <div style="margin-top:10px">
        <button id="filterBtn" class="primary">Apply Filter</button>
      </div>
    </div>

    <div id="tableWrap"></div>

    <details style="margin-top:12px">
      <summary>Debug / Last backend responses</summary>
      <pre id="debugDash" class="debug">no calls yet</pre>
    </details>
  </section>

  <footer class="muted" style="margin-top:10px">Make sure API URL (window.API_URL) points to your Netlify function.</footer>
</div>

<script>
/* ---------- tiny helpers ---------- */
function dbg(id, obj){
  try { document.getElementById(id).textContent = JSON.stringify(obj, null, 2); }
  catch(e){ console.log('dbg set fail', id, e); }
}
function showStatus(msg){ document.getElementById('status').innerText = msg; }
function qs(id){ return document.getElementById(id); }

/* ---------- tabs ---------- */
const tabCreate = qs('tabCreate'), tabDash = qs('tabDashboard'), secCreate = qs('createSection'), secDash = qs('dashboardSection');
tabCreate.addEventListener('click', ()=>{ tabCreate.classList.add('active'); tabDash.classList.remove('active'); secCreate.style.display='block'; secDash.style.display='none'; });
tabDash.addEventListener('click', ()=>{ tabDash.classList.add('active'); tabCreate.classList.remove('active'); secCreate.style.display='none'; secDash.style.display='block'; });

/* ---------- network helpers ---------- */
async function api(action, payload){
  if (!window.API_URL) throw new Error('API_URL not set');
  const body = { action, payload };
  const res = await fetch(window.API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  const txt = await res.text();
  try { return JSON.parse(txt); } catch(e) { return txt; }
}

/* ---------- create page logic ---------- */
async function loadCreateOptions(){
  try {
    const dd = await api('getDropdownData');
    let data = dd && dd.data ? dd.data : (dd || {});
    const posts = ['Engg','GRS','Schive','AE','Other'];
    const postSel = qs('post'); postSel.innerHTML = '<option value="">--select post--</option>';
    posts.forEach(p => { const o=document.createElement('option'); o.value=p; o.textContent=p; postSel.appendChild(o); });

    const pans = data.allPanchayats || [];
    const pSel = qs('panchayats'); pSel.innerHTML = '';
    pans.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; pSel.appendChild(o); });

    dbg('debugCreate', { posts, pans });
  } catch(err){
    dbg('debugCreate', {error: String(err)});
  }
}

qs('btnPreview').addEventListener('click', async function(){
  const name = qs('name').value.trim();
  const post = qs('post').value.trim();
  const dcode = qs('dcode').value.trim() || '77';
  const sel = qs('panchayats');
  const pans = Array.from(sel.selectedOptions).map(o=>o.value);
  if (!name || !post || pans.length===0) { showStatus('Fill name, post and select at least 1 panchayat'); return; }
  try {
    const srRes = await api('getNextSrForPreview', {});
    let sr = 1;
    if (srRes && srRes.result) sr = srRes.result;
    else if (typeof srRes === 'number') sr = srRes;
    const a = (name.substr(0,3) || '').toLowerCase();
    const b = (post.substr(0,2) || '').toLowerCase();
    const d = ((''+dcode).slice(-2) || '').toLowerCase();
    const s = ((''+sr).slice(-2) || '').toLowerCase();
    const uid = (a + b + d + s).toLowerCase();
    qs('preview').innerHTML = '<b>UserID (if new):</b> ' + uid + '<br><b>Panchayats:</b> ' + pans.join(', ');
    showStatus('');
    dbg('debugCreate', { preview_for: name, sr: sr, userid: uid });
  } catch(err){
    dbg('debugCreate', { error: String(err) });
  }
});

qs('btnSave').addEventListener('click', async function(){
  const name = qs('name').value.trim();
  const post = qs('post').value.trim();
  const dcode = qs('dcode').value.trim() || '77';
  const sel = qs('panchayats');
  const pans = Array.from(sel.selectedOptions).map(o=>o.value);
  if (!name || !post || pans.length===0) { showStatus('Fill name, post and select at least 1 panchayat'); return; }
  qs('btnSave').disabled = true;
  showStatus('Saving...');
  try {
    const resp = await api('appendOrUpdateUser', { name, post, panchayats: pans, dcode });
    dbg('debugCreate', resp);
    showStatus('Saved: ' + (resp.result && resp.result.userid ? resp.result.userid : JSON.stringify(resp)));
  } catch(err){
    showStatus('Save error: ' + String(err));
    dbg('debugCreate', { saveException: String(err) });
  } finally {
    qs('btnSave').disabled = false;
  }
});

/* ---------- dashboard logic ---------- */
let dropdownData = null;
let loggedUser = null;

async function initDashboardTemplates(){
  try {
    const dd = await api('getDropdownData', {});
    if (dd && dd.data) dropdownData = dd.data;
    else dropdownData = { engineers:[], works:[], status:[], years:[], allPanchayats:[], gpsByEngineer:{}, categories:[], updateTime:'' };
    qs('lastUpdate') && (qs('lastUpdate').innerText = 'Last Update: ' + (dropdownData.updateTime || ''));
    loadCreateOptions(); // also populate create lists
  } catch(err){
    dbg('debugDash', { error: String(err) });
  }
}

function populateSelect(id, arr){
  const sel = qs(id);
  if (!sel) return;
  sel.innerHTML = '<option value="">--All--</option>';
  (arr||[]).forEach(v => {
    const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o);
  });
}

document.getElementById('loginBtn').addEventListener('click', function(){
  const v = qs('loginInput').value.trim();
  if (!v) return alert('Enter UserID or Name');
  doLogin(v);
});

document.getElementById('logoutBtn').addEventListener('click', function(){
  qs('loginInput').value = '';
  qs('userInfo').innerText = '';
  qs('filtersCard').style.display = 'none';
  qs('tableWrap').innerHTML = '';
  qs('logoutBtn').style.display = 'none';
});

async function doLogin(val){
  try {
    const res = await api('validateUser', { input: val });
    dbg('debugDash', { validate: res });
    let r = res;
    if (r && r.user) r = r;
    if (!r || (r.ok===false && !r.user)) { alert('Invalid user or backend error'); return; }
    const userObj = (r.user && r.user.valid!==undefined) ? r.user : (r.user || r);
    if (!userObj || !userObj.valid) { alert('Invalid UserID/Name'); return; }
    loggedUser = userObj;
    qs('userInfo').innerText = 'Logged in: ' + (userObj.name || userObj.userid) + ' (' + (userObj.userid||'') + ') - Panchayats: ' + (userObj.panchayats||[]).join(', ');
    qs('logoutBtn').style.display = 'inline-block';
    // gp dropdown = only user's panchayats
    const gp = qs('gp'); gp.innerHTML = '<option value="">--All--</option>';
    (userObj.panchayats || []).forEach(p => { const o = document.createElement('option'); o.value = p; o.textContent = p; gp.appendChild(o); });

    // filter engineers to only those who have these panchayats
    const dd = dropdownData || {};
    const gpsByEngineer = dd.gpsByEngineer || {};
    const engines = Object.keys(gpsByEngineer).filter(e => {
      const arr = (gpsByEngineer[e]||[]).map(x=>(''+x).trim().toLowerCase());
      return (userObj.panchayats||[]).some(up => arr.indexOf((''+up).trim().toLowerCase()) !== -1);
    });
    populateSelect('engineer', engines);
    populateSelect('work', dd.works || []);
    populateSelect('status', dd.status || []);
    populateSelect('year', dd.years || []);
    populateSelect('category', dd.categories || []);
    qs('filtersCard').style.display = 'block';
    await fetchTable({}, userObj.userid);
  } catch(err){
    dbg('debugDash', { loginError: String(err) });
    alert('Login error: '+ String(err));
  }
}

qs('filterBtn').addEventListener('click', async function(){
  const filter = {
    engineer: qs('engineer').value,
    gp: qs('gp').value,
    year: qs('year').value,
    work: qs('work').value,
    status: qs('status').value,
    category: qs('category').value,
    search: qs('search').value.trim()
  };
  const userid = (new URLSearchParams(window.location.search)).get('userid') || qs('loginInput').value.trim();
  await fetchTable(filter, userid);
});

async function fetchTable(filter, userid){
  try {
    qs('tableWrap').innerHTML = '<div class="muted">Loading...</div>';
    const payload = { filter: filter || {}, userid: userid || '' };
    const res = await api('getFilteredData', payload);
    dbg('debugDash', { filteredRes: res });
    let rows = [];
    if (res && res.rows) rows = res.rows;
    else if (Array.isArray(res)) rows = res;
    else if (res && res.body) {
      try { const parsed = JSON.parse(res.body); if (parsed.rows) rows = parsed.rows; } catch(e){}
    }
    renderTable(rows);
  } catch(err){
    dbg('debugDash', { fetchTableError: String(err) });
    qs('tableWrap').innerHTML = '<div class="muted">Error fetching data</div>';
  }
}

/* ---------- table rendering + details (updated) ---------- */
function renderTable(rows){
  const wrap = qs('tableWrap');
  wrap.innerHTML = '';
  if (!rows || rows.length === 0) { wrap.innerHTML = '<div class="card muted">No data for selected filters</div>'; return; }

  const tbl = document.createElement('table');
  // header (client side)
  const headers = [
    "S No.","Name of work","Panchayat","Work Type","Year","Status",
    "Unskilled","Semi-skilled","Skilled","Contingency","Material","Total Section",
    "Exp Unskilled","Exp Semi-skilled","Exp Skilled","Exp Contingency","Exp Material","Total Exp",
    "% Exp","Balance Mandays","Category"
  ];
  const thead = document.createElement('thead');
  const hr = document.createElement('tr');
  headers.forEach(h => { const th = document.createElement('th'); th.textContent = h; hr.appendChild(th); });
  thead.appendChild(hr);
  tbl.appendChild(thead);

  const tbody = document.createElement('tbody');
  rows.forEach((r, idx) => {
    const tr = document.createElement('tr');
    tr.addEventListener('click', () => { showDetails(r, idx+1); });

    const row = Array.isArray(r) ? r : [];

    // determine serial
    let sr = idx + 1;
    if (row[0] && !isNaN(Number(row[0]))) sr = Number(row[0]);

    const visible = [
      sr,            // S No.
      row[4] || '',  // Name of work
      row[2] || '',  // Panchayat
      row[3] || '',  // Work Type
      row[5] || '',  // Year
      row[6] || '',  // Status
      row[7] || '',  // Unskilled
      row[8] || '',  // Semi-skilled
      row[9] || '',  // Skilled
      row[11] || '', // Contingency
      row[10] || '', // Material
      row[12] || '', // Total Section
      row[13] || '', // Exp Unskilled
      row[14] || '', // Exp Semi-skilled
      row[15] || '', // Exp Skilled
      row[17] || '', // Exp Contingency
      row[16] || '', // Exp Material
      row[18] || '', // Total Exp
      row[21] || '', // % Exp
      row[20] || '', // Balance Mandays
      row[19] || ''  // Category
    ];

    visible.forEach(cellVal => {
      const td = document.createElement('td');
      td.textContent = (cellVal === null || cellVal === undefined) ? '' : cellVal;
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
  wrap.appendChild(tbl);
}

/* showDetails: show a detail panel on right side (or modal) */
function showDetails(row, computedSr) {
  const r = Array.isArray(row) ? row : [];
  const sr = (r[0] && !isNaN(Number(r[0]))) ? Number(r[0]) : (computedSr || '');
  const nameOfWork = r[4] || '';
  const panchayat = r[2] || '';
  const workType = r[3] || '';
  const year = r[5] || '';
  const status = r[6] || '';

  const unskilled = r[7] || '';
  const semiskilled = r[8] || '';
  const skilled = r[9] || '';
  const contingency = r[11] || '';
  const material = r[10] || '';
  const totalSection = r[12] || '';

  const expUnskilled = r[13] || '';
  const expSemiskilled = r[14] || '';
  const expSkilled = r[15] || '';
  const expContingency = r[17] || '';
  const expMaterial = r[16] || '';
  const totalExp = r[18] || '';

  const percentExp = r[21] || '';
  const balanceMandays = r[20] || '';
  const category = r[19] || '';
  const remark = r[22] || '';

  let panel = document.getElementById('detailPanel');
  if (!panel) {
    panel = document.createElement('div'); panel.id = 'detailPanel'; panel.className = 'detail-panel card';
    panel.innerHTML = '<div class="detail-close" id="detailClose">âœ•</div><h3 id="detailTitle">Row Details</h3><div id="detailBody"></div>';
    document.body.appendChild(panel);
    document.getElementById('detailClose').addEventListener('click', ()=>{ panel.style.display='none'; });
  }

  const title = panel.querySelector('#detailTitle');
  const body = panel.querySelector('#detailBody');
  title.textContent = (nameOfWork || 'Name of work');
  body.innerHTML = '';

  const addKV = (k,v) => {
    const kv = document.createElement('div'); kv.className='kv';
    kv.style.display='flex'; kv.style.justifyContent='space-between'; kv.style.padding='6px 0'; kv.style.borderBottom='1px dashed #eef3fb';
    const left = document.createElement('div'); left.style.color='#444'; left.textContent=k;
    const right = document.createElement('div'); right.style.color='#062'; right.textContent=v;
    kv.appendChild(left); kv.appendChild(right); body.appendChild(kv);
  };

  addKV('S No.', sr);
  addKV('Name of work', nameOfWork);
  addKV('Panchayat', panchayat);
  addKV('Work Type', workType);
  addKV('Year', year);
  addKV('Status', status);

  addKV('Unskilled (section)', unskilled);
  addKV('Semi-skilled (section)', semiskilled);
  addKV('Skilled (section)', skilled);
  addKV('Contingency (section)', contingency);
  addKV('Material (section)', material);
  addKV('Total Section', totalSection);

  addKV('Exp. Unskilled', expUnskilled);
  addKV('Exp. Semi-skilled', expSemiskilled);
  addKV('Exp. Skilled', expSkilled);
  addKV('Exp. Contingency', expContingency);
  addKV('Exp. Material', expMaterial);
  addKV('Total Expenditure', totalExp);

  addKV('% Expenditure', percentExp);
  addKV('Balance Mandays', balanceMandays);
  addKV('Category', category);
  if (remark) addKV('Remark', remark);

  panel.style.display = 'block';
  panel.scrollTop = 0;
}

/* ---------- on load ---------- */
(async function onLoad(){
  await initDashboardTemplates();
  // show dashboard tab by default
  tabDash.click();

  // auto-login if userid param present
  const urlParams = new URLSearchParams(window.location.search);
  const u = urlParams.get('userid');
  if (u) { qs('loginInput').value = u; await doLogin(u); }
})();
</script>
</body>
</html>